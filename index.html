<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta
      name="description"
      content="A Pomodoro Focus App with customizable timers, streaks, tasks, subtasks, and ambient music."
    />
    <title>Pomodoro Focus App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              gray: {
                900: '#0d1117', /* GitHub Dark Bg */
                800: '#161b22', /* GitHub Panel Bg */
                700: '#21262d', /* GitHub Border */
              },
              green: {
                400: '#4ade80',
                900: '#064e3b',
              }
            },
            screens: {
              'xs': '375px',
            }
          }
        }
      }
    </script>
    <style>
      /* Base styles */
      :root {
        --base-font-size: 16px;
      }
      
      /* Timer animations */
      .dash-ring {
        stroke-dasharray: 283;
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 1s linear;
      }

      @keyframes bounce {
        0%, 100% { transform: translateY(0) scale(var(--scale, 1)); }
        50% { transform: translateY(-10px) scale(var(--scale, 1)); }
      }

      .tree-bounce {
        animation: bounce 2s infinite ease-in-out;
      }

      /* Focus Music Container */
      .media-container {
        border: 4px solid #1f2937; /* dark-gray-800 */
        border-radius: 1rem;
        overflow: hidden;
        width: 100%;
        background: #000;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease; /* Smooth transition for resizing */
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent; 
      }
      ::-webkit-scrollbar-thumb {
        background: #4ade80; 
        border-radius: 4px;
      }

      .hidden {
        display: none !important;
      }

      /* Digital Clock Style */
      .digital-clock {
        font-family: 'Courier New', Courier, monospace;
        text-shadow: 0 0 5px rgba(74, 222, 128, 0.5);
      }

      /* GitHub Graph Styles */
      .github-graph {
        display: grid;
        grid-template-rows: repeat(7, 10px);
        grid-auto-flow: column;
        gap: 3px;
      }
      
      @media (min-width: 768px) {
        .github-graph {
             grid-template-rows: repeat(7, 12px);
        }
      }
      
      .contrib-cell {
        width: 10px;
        height: 10px;
        border-radius: 2px;
      }

      @media (min-width: 768px) {
        .contrib-cell {
            width: 12px;
            height: 12px;
        }
      }

      /* Subtask Styles */
      .subtask-line {
        position: relative;
      }
      .subtask-line::before {
        content: '';
        position: absolute;
        left: -12px;
        top: -15px;
        bottom: 50%;
        width: 2px;
        background-color: #e5e7eb; /* gray-200 */
      }
      .dark .subtask-line::before {
        background-color: #374151; /* gray-700 */
      }
      .subtask-line::after {
        content: '';
        position: absolute;
        left: -12px;
        top: 50%;
        width: 10px;
        height: 2px;
        background-color: #e5e7eb;
      }
      .dark .subtask-line::after {
        background-color: #374151;
      }
    </style>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen pb-32">
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
      
      <!-- Top Bar -->
      <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
        <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
            <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">Focus Flow üå≥</h1>
            
            <!-- Realtime Clock Display -->
            <div class="bg-white dark:bg-gray-800 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 flex flex-col items-center justify-center w-full sm:w-auto min-w-[160px] shadow-sm">
                <div id="timeDisplay" class="text-lg sm:text-xl font-bold digital-clock text-green-600 dark:text-green-400">00:00:00</div>
                <div id="dateDisplay" class="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400 font-medium uppercase tracking-wider">Loading...</div>
            </div>
        </div>
        
        <div class="flex flex-wrap items-center gap-3 sm:gap-4 justify-center w-full md:w-auto">
          <!-- Theme Toggle -->
          <div class="flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700">
            <i data-lucide="sun" class="w-4 h-4 text-gray-500"></i>
            <select id="themeSelect" class="bg-transparent text-sm focus:outline-none cursor-pointer">
              <option value="system">Auto</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>

          <!-- Break Music Toggle -->
          <div class="relative">
             <div class="flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="musicToggle" class="sr-only peer">
                  <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-green-600"></div>
                  <span class="ml-2 text-xs sm:text-sm font-medium">Break Music</span>
                </label>
                <!-- Gear Icon for settings -->
                <button id="openMusicSettings" class="ml-2 text-gray-500 hover:text-green-600 dark:hover:text-green-400 transition-colors" title="Music Settings">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                </button>
             </div>
          </div>

          <!-- Calendar Button -->
          <button id="openCalendar" class="flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <i data-lucide="calendar" class="w-4 h-4 text-blue-500"></i>
              <span class="text-xs sm:text-sm font-medium hidden sm:inline">Calendar</span>
          </button>

          <!-- Google Login / User Profile -->
          <div id="authSection" class="flex items-center">
              <button id="googleLoginBtn" class="flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                  <!-- Google Icon -->
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                  <span class="text-xs sm:text-sm font-medium">Sign in</span>
              </button>
              <div id="userProfile" class="hidden flex items-center gap-2">
                  <img id="userAvatar" src="" alt="User" class="w-8 h-8 rounded-full border border-gray-300 dark:border-gray-700 object-cover">
                  <button id="logoutBtn" class="text-xs text-red-500 hover:text-red-600 font-medium px-2">Sign out</button>
              </div>
          </div>

        </div>
      </div>

      <!-- DB Status Indicator -->
      <div id="dbStatus" class="text-xs text-center text-gray-400 mb-4 opacity-0 transition-opacity">Cloud Storage Connected</div>

      <!-- Main Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 mb-12">
        
        <!-- LEFT COLUMN: Timer & Tasks (lg:col-span-7) -->
        <div class="lg:col-span-7 flex flex-col gap-6">
            <!-- Timer Card -->
            <div class="p-6 md:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-xl flex flex-col items-center justify-between min-h-[420px] md:min-h-[500px] relative overflow-hidden transition-all">
              
              <!-- Active Task Indicator -->
              <div id="currentTaskDisplay" class="absolute top-0 left-0 w-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 py-2 px-4 text-center text-xs sm:text-sm font-medium hidden">
                  Current Task: <span id="currentTaskTitle" class="font-bold">Writing Code</span>
              </div>

              <h2 class="text-xl md:text-2xl font-bold mb-4 mt-8 text-green-600 dark:text-green-400 text-center" id="modeLabel">Focus Session</h2>
              
              <!-- Circular Timer -->
              <div class="relative w-60 h-60 sm:w-72 sm:h-72 flex items-center justify-center shrink-0">
                <svg class="absolute w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                  <circle cx="50" cy="50" r="45" class="fill-none stroke-gray-200 dark:stroke-gray-700" stroke-width="6" />
                  <circle id="timerRing" cx="50" cy="50" r="45" class="fill-none stroke-green-500 dash-ring" stroke-width="6" stroke-linecap="round" />
                </svg>
                
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                  <div id="treeContainer" class="text-5xl sm:text-6xl mb-2 sm:mb-4 transition-transform duration-500 origin-bottom" style="--scale: 1">üå±</div>
                  <div id="pauseIcon" class="text-3xl sm:text-4xl mb-2 hidden animate-pulse">‚è∏Ô∏è</div>
                  <div id="timerDisplay" class="text-5xl sm:text-6xl font-mono font-bold tracking-tighter transition-all">25:00</div>
                </div>
              </div>

              <!-- Controls -->
              <div class="w-full mt-6 sm:mt-8 space-y-6">
                <div class="flex justify-center gap-4 sm:gap-6 text-xs sm:text-sm">
                  <div class="flex flex-col items-center gap-1">
                    <label for="focusTime" class="font-semibold text-gray-500 dark:text-gray-400">Focus</label>
                    <select id="focusTime" class="px-3 py-1.5 rounded bg-gray-100 dark:bg-gray-700 border-none outline-none cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition w-20 text-center">
                      <option value="25">25m</option>
                      <option value="30">30m</option>
                      <option value="45">45m</option>
                      <option value="60">60m</option>
                    </select>
                  </div>
                  <div class="flex flex-col items-center gap-1">
                    <label for="breakTime" class="font-semibold text-gray-500 dark:text-gray-400">Break</label>
                    <select id="breakTime" class="px-3 py-1.5 rounded bg-gray-100 dark:bg-gray-700 border-none outline-none cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition w-20 text-center">
                      <option value="5">5m</option>
                      <option value="10">10m</option>
                      <option value="15">15m</option>
                    </select>
                  </div>
                </div>

                <div class="flex gap-3 justify-center flex-wrap">
                  <button id="startButton" class="px-6 py-2.5 sm:px-8 sm:py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-lg hover:shadow-green-500/30 transition-all transform hover:scale-105 active:scale-95 text-sm sm:text-base w-full xs:w-auto">
                    Start Focus
                  </button>
                  <button id="pauseButton" class="hidden px-6 py-2.5 sm:px-8 sm:py-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95 text-sm sm:text-base w-full xs:w-auto">
                    Pause
                  </button>
                  <button id="resetButton" class="hidden px-6 py-2.5 sm:px-8 sm:py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95 text-sm sm:text-base w-full xs:w-auto">
                    Reset
                  </button>
                  <button id="skipBreak" class="hidden px-6 py-2.5 sm:px-8 sm:py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95 text-sm sm:text-base w-full xs:w-auto">
                    Skip Break
                  </button>
                </div>
              </div>
            </div>

            <!-- Tasks Section -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                        <i data-lucide="check-square" class="w-5 h-5"></i> Tasks
                    </h2>
                    <div class="flex gap-2">
                         <button id="toggleSync" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 p-2 rounded-lg transition-colors" title="Import/Export for Apple Reminders">
                            <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                        </button>
                        <button id="toggleAddTask" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 p-2 rounded-lg transition-colors">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                 <!-- Sync / Import Modal -->
                <div id="syncModal" class="hidden mb-4 bg-gray-50 dark:bg-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold text-sm mb-2 flex items-center gap-2">
                         <i data-lucide="refresh-cw" class="w-4 h-4"></i> Sync with Apple Reminders
                    </h3>
                    <div class="flex gap-2 mb-3">
                        <button id="copyToReminders" class="flex-1 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg flex items-center justify-center gap-2">
                             <i data-lucide="copy" class="w-3 h-3"></i> Copy Tasks
                        </button>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                         <textarea id="importText" rows="3" class="w-full px-3 py-2 text-xs rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-800 focus:outline-none mb-2" placeholder="Paste your list here..."></textarea>
                         <button id="importTasksBtn" class="w-full px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg">
                            Import Tasks
                        </button>
                    </div>
                    <div class="text-right mt-2">
                         <button id="closeSync" class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Close</button>
                    </div>
                </div>

                <!-- Add/Edit Task Form -->
                <div id="addTaskForm" class="hidden mb-4 bg-gray-50 dark:bg-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                    <h3 id="formTitle" class="text-xs font-bold text-gray-500 mb-2 uppercase">Add New Task</h3>
                    <input type="text" id="newTaskTitle" placeholder="What are you working on?" class="w-full mb-3 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-800 focus:ring-2 focus:ring-green-500 outline-none text-sm">
                    <div class="flex items-center gap-4 mb-3">
                        <span class="text-sm font-semibold">Est Pomodoros:</span>
                        <input type="number" id="newTaskEst" value="1" min="1" max="10" class="w-16 px-2 py-1 rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-800 text-sm">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="cancelAddTask" class="px-3 py-1 text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Cancel</button>
                        <button id="saveTask" class="px-4 py-1.5 bg-green-500 text-white rounded-lg text-xs font-bold hover:bg-green-600">SAVE</button>
                    </div>
                </div>

                <!-- Task List -->
                <div id="taskList" class="space-y-4 max-h-[500px] overflow-y-auto pr-1">
                    <div class="text-center text-gray-500 py-4 italic text-sm">Loading tasks...</div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Stats & Music (lg:col-span-5) -->
        <div class="lg:col-span-5 flex flex-col gap-6">
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-3 sm:gap-4">
                 <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="text-[10px] sm:text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Current Streak</h3>
                    <div id="streakCounter" class="text-xl sm:text-2xl font-bold">0 üî•</div>
                </div>
                <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                    <h3 class="text-[10px] sm:text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Total Hours</h3>
                    <div id="totalFocus" class="text-xl sm:text-2xl font-bold text-green-500">0h 0m</div>
                </div>
            </div>

            <!-- Focus Music Container -->
            <div class="p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl flex flex-col">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg sm:text-xl font-bold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                  <i data-lucide="headphones" class="w-5 h-5"></i> Focus Ambience
                </h2>
                <button id="openFocusSettings" class="text-gray-500 hover:text-green-600 dark:hover:text-green-400 transition-colors" title="Change Music">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                </button>
              </div>
              <div id="focusMediaContainer" class="media-container flex-1 w-full relative">
                <!-- Content injected by JS -->
                <iframe 
                  id="focusPlayer"
                  src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=0" 
                  title="Focus Music"
                  width="100%" 
                  height="100%" 
                  frameborder="0" 
                  allow="autoplay; encrypted-media; picture-in-picture" 
                  allowfullscreen
                  class="w-full h-full object-cover absolute inset-0">
                </iframe>
              </div>
            </div>

            <!-- GitHub Style Activity Map -->
            <div class="p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg sm:text-xl font-bold flex items-center gap-2">
                      <i data-lucide="activity" class="w-5 h-5"></i> Activity Map
                  </h3>
                  <div class="text-[10px] sm:text-xs text-gray-500">Last 365 Days</div>
                </div>
                
                <div class="overflow-x-auto pb-2 custom-scrollbar">
                    <div id="githubGraph" class="github-graph min-w-max">
                        <!-- Graph injected JS -->
                    </div>
                </div>
                
                <div class="flex items-center gap-1.5 sm:gap-2 mt-4 text-[10px] sm:text-xs text-gray-500 justify-end">
                    <span>Less</span>
                    <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-gray-200 dark:bg-gray-700 rounded-[2px]"></div>
                    <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-green-200 dark:bg-green-900 rounded-[2px]"></div>
                    <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-green-400 dark:bg-green-700 rounded-[2px]"></div>
                    <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-green-600 dark:bg-green-500 rounded-[2px]"></div>
                    <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-green-900 dark:bg-green-300 rounded-[2px]"></div>
                    <span>More</span>
                </div>
            </div>
            
        </div>
      </div>

      <!-- Break Music Settings Modal -->
      <div id="musicSettingsModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm px-4">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md border border-gray-200 dark:border-gray-700 transform transition-all scale-100">
              <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold flex items-center gap-2">
                      <i data-lucide="music" class="w-5 h-5"></i> Break Music Settings
                  </h3>
                  <button id="closeMusicSettings" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                      <i data-lucide="x" class="w-5 h-5"></i>
                  </button>
              </div>
              <p class="text-sm text-gray-500 mb-4">Enter a YouTube URL to play during break sessions automatically.</p>
              <form id="urlForm" class="flex flex-col gap-3">
                  <input type="text" id="videoUrl" placeholder="https://youtube.com/watch?v=..." 
                         class="w-full px-4 py-2.5 text-sm rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900 focus:ring-2 focus:ring-green-500 outline-none" />
                  <button type="submit" class="w-full px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors">
                    Save Music URL
                  </button>
              </form>
          </div>
      </div>

      <!-- Focus Music Settings Modal -->
      <div id="focusSettingsModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm px-4">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md border border-gray-200 dark:border-gray-700 transform transition-all scale-100">
              <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold flex items-center gap-2">
                      <i data-lucide="headphones" class="w-5 h-5"></i> Focus Music Settings
                  </h3>
                  <button id="closeFocusSettings" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                      <i data-lucide="x" class="w-5 h-5"></i>
                  </button>
              </div>
              <form id="focusMusicForm" class="flex flex-col gap-4">
                  <div>
                      <label class="block text-sm font-medium mb-2 text-gray-600 dark:text-gray-400">Source</label>
                      <div class="flex gap-4">
                          <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition w-1/2">
                              <input type="radio" name="focusSource" value="youtube" checked class="text-green-500 focus:ring-green-500">
                              <span class="text-sm font-medium">YouTube</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition w-1/2">
                              <input type="radio" name="focusSource" value="spotify" class="text-green-500 focus:ring-green-500">
                              <span class="text-sm font-medium">Spotify</span>
                          </label>
                      </div>
                  </div>
                  <div>
                      <label class="block text-sm font-medium mb-1 text-gray-600 dark:text-gray-400">URL</label>
                      <input type="text" id="focusVideoUrl" placeholder="Paste URL here..." 
                             class="w-full px-4 py-2.5 text-sm rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900 focus:ring-2 focus:ring-green-500 outline-none" />
                      <p class="text-xs text-gray-500 mt-1" id="focusUrlHelp">YouTube Video or Playlist link.</p>
                  </div>
                  <button id="saveFocusMusicBtn" type="submit" class="w-full px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors">
                    Save & Play
                  </button>
              </form>
          </div>
      </div>

      <!-- Calendar Dashboard Modal -->
      <div id="calendarModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-6xl h-[85vh] flex flex-col border border-gray-200 dark:border-gray-700 overflow-hidden">
              <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                  <h3 class="text-lg font-bold flex items-center gap-2">
                      <i data-lucide="calendar-days" class="w-5 h-5 text-blue-500"></i> Schedule & Dashboard
                  </h3>
                  <button id="closeCalendar" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                      <i data-lucide="x" class="w-5 h-5"></i>
                  </button>
              </div>
              <div class="flex-1 w-full bg-white relative">
                   <div class="absolute inset-0 flex items-center justify-center text-gray-400 z-0">Loading Calendar...</div>
                   <iframe src="https://calendar.google.com/calendar/embed?src=engineerfelex%40gmail.com&ctz=Africa%2FNairobi" style="border: 0" width="100%" height="100%" frameborder="0" scrolling="no" class="relative z-10"></iframe>
              </div>
          </div>
      </div>

      <!-- Break Music Player -->
      <div id="musicPlayer" class="fixed bottom-0 right-0 left-0 md:left-auto md:bottom-4 md:right-4 z-50 transition-transform duration-300 translate-y-[150%] shadow-2xl md:rounded-lg rounded-t-xl overflow-hidden border-t-2 md:border-2 border-blue-500 w-full md:w-80 bg-black h-auto">
        <div class="bg-blue-600 text-white px-4 py-2 text-sm flex justify-between items-center">
          <span class="font-bold flex items-center gap-2">üéµ Break Time Music</span>
          <button id="closeMusicPlayer" class="hover:bg-blue-700 p-1 rounded transition-colors">
              <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="aspect-video w-full">
            <iframe 
              id="youtubePlayer" 
              width="100%" 
              height="100%" 
              frameborder="0" 
              allow="autoplay; encrypted-media"
              class="bg-black w-full h-full">
            </iframe>
        </div>
      </div>

      <!-- Snackbar -->
      <div id="snackbar" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 opacity-0 transition-opacity duration-300 pointer-events-none text-sm w-max max-w-[90vw] text-center"></div>

    </div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Init Icons
        lucide.createIcons();

        // -------------------- Realtime Clock Logic --------------------
        function updateClock() {
            const now = new Date();
            const timeElement = document.getElementById('timeDisplay');
            const dateElement = document.getElementById('dateDisplay');
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            timeElement.textContent = `${hours}:${minutes}:${seconds}`;

            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            dateElement.textContent = now.toLocaleDateString('en-US', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // -------------------- Firebase Integration --------------------
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : "FIREBASE_CONFIG_PLACEHOLDER";

        const configToUse = typeof firebaseConfig === 'string' && firebaseConfig !== "FIREBASE_CONFIG_PLACEHOLDER" 
                            ? JSON.parse(firebaseConfig) 
                            : (typeof firebaseConfig === 'object' ? firebaseConfig : {});

        const app = initializeApp(configToUse);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let userId = null;
        let editingTaskId = null;
        let cachedSettings = {};

        // Auth & Init
        const initAuth = async () => {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            // Fallback handled by onAuthStateChanged
          }
        };
        // Trigger init check
        onAuthStateChanged(auth, async (user) => {
            const loginBtn = document.getElementById('googleLoginBtn');
            const userProfile = document.getElementById('userProfile');
            const userAvatar = document.getElementById('userAvatar');

            if (user) {
                // --- USER IS LOGGED IN ---
                userId = user.uid;

                if (!user.isAnonymous) {
                    loginBtn.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    userAvatar.src = user.photoURL || 'https://via.placeholder.com/32';
                    showSnackbar(`Welcome, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}!`, "success");
                } else {
                    loginBtn.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                }

                document.getElementById('dbStatus').style.opacity = '1';
                setTimeout(() => document.getElementById('dbStatus').style.opacity = '0', 5000);
                await loadSettings();
                loadFromFirestore();
                restoreLocalState();
            } else {
                // --- USER IS LOGGED OUT (Guest/Default Data) ---
                userId = null;
                cachedSettings = {}; // Clear settings
                
                // Show Login Button
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden');

                // Clear Data from UI
                document.getElementById('totalFocus').textContent = "0h 0m";
                document.getElementById('streakCounter').textContent = "0 üî•";
                document.getElementById('githubGraph').innerHTML = '<div class="text-xs text-gray-500 p-2">Sign in to view activity history</div>';
                document.getElementById('taskList').innerHTML = '<div class="text-center text-gray-500 py-8 italic text-sm">Sign in with Google to manage your tasks.</div>';
                document.getElementById('currentTaskDisplay').classList.add('hidden');
                
                // Reset Theme to default if needed, or leave as last selected
                // (Optional: resetTimer() here if you want to stop timer on logout)
            }
        });

        // --- Google Login Logic ---
        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                showSnackbar("Login failed: " + error.message, "error");
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
                window.location.reload(); 
            } catch (error) {
                console.error("Logout failed", error);
            }
        };

        document.getElementById('googleLoginBtn').addEventListener('click', window.loginWithGoogle);
        document.getElementById('logoutBtn').addEventListener('click', window.logout);


        // -------------------- Firestore Logic --------------------
        
        const getTasksRef = () => collection(db, 'artifacts', appId, 'users', userId, 'tasks');
        const getTaskSubtasksRef = (taskId) => collection(db, 'artifacts', appId, 'users', userId, 'tasks', taskId, 'subtasks');
        const getSessionsRef = () => collection(db, 'artifacts', appId, 'users', userId, 'focus_sessions');
        const getSettingsRef = () => collection(db, 'artifacts', appId, 'users', userId, 'settings');

        async function loadSettings() {
            if(!userId) return;
            try {
                const docRef = doc(getSettingsRef(), 'config');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    cachedSettings = docSnap.data();
                    if(cachedSettings.theme) {
                        document.getElementById('themeSelect').value = cachedSettings.theme;
                        applyTheme(cachedSettings.theme);
                    }
                    if(cachedSettings.music_enabled !== undefined) {
                        const enabled = cachedSettings.music_enabled === 'true';
                        document.getElementById('musicToggle').checked = enabled;
                    }
                    // Pre-fill Break Music URL if exists
                    if(cachedSettings.custom_music_url) {
                        document.getElementById('videoUrl').value = cachedSettings.custom_music_url;
                    }
                    
                    // Initialize Focus Music
                    const type = cachedSettings.focus_music_type || 'youtube';
                    const url = cachedSettings.focus_music_url;
                    updateFocusMusicPlayer(type, url);
                    
                    // Pre-fill Focus Settings Form
                    const rbs = document.querySelectorAll('input[name="focusSource"]');
                    for(const rb of rbs) {
                        if(rb.value === type) rb.checked = true;
                    }
                    if(url) document.getElementById('focusVideoUrl').value = url;
                    
                } else {
                    // Initialize default focus music if no settings exist
                    updateFocusMusicPlayer('youtube', null);
                }
            } catch (e) {
                console.error("Error loading settings", e);
                updateFocusMusicPlayer('youtube', null); // Fallback
            }
        }

        async function saveSetting(key, value) {
            if(!userId) return;
            cachedSettings[key] = value;
            try {
                await setDoc(doc(getSettingsRef(), 'config'), cachedSettings, { merge: true });
            } catch(e) {
                console.error("Save setting failed", e);
            }
        }

        function updateFocusMusicPlayer(type, url) {
            const container = document.getElementById('focusMediaContainer');
            const player = document.getElementById('focusPlayer');
            let src = "";

            if (type === 'spotify') {
                const defaultSpotify = "https://open.spotify.com/embed/playlist/5acGzAC0OH4QDVj5hlFqlK?utm_source=generator";
                
                if (url) {
                    if (url.includes('open.spotify.com/embed')) {
                        src = url;
                    } else if (url.includes('open.spotify.com')) {
                        src = url.replace('open.spotify.com/', 'open.spotify.com/embed/');
                    } else {
                        src = defaultSpotify; 
                    }
                } else {
                    src = defaultSpotify;
                }
                
                // Spotify styles: Needs fixed height, remove absolute positioning
                container.style.aspectRatio = "auto";
                container.style.height = "auto"; // Let content dictate height
                container.classList.remove('absolute', 'inset-0'); // Safety removal if added to container
                
                player.style.height = "352px"; 
                player.style.position = "relative"; // Reset position
                player.classList.remove('absolute', 'inset-0', 'h-full'); // Remove Tailwind absolute classes
                
                player.src = src;
                player.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
                
            } else {
                // Default YouTube (Lofi Girl)
                const defaultYT = `https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=0`;
                
                if (url) {
                    const embedUrl = getEmbedUrl(url); // Re-use existing YT parser
                    src = embedUrl ? embedUrl : defaultYT;
                } else {
                    src = defaultYT;
                }
                
                // YouTube styles: Needs 16:9 Aspect Ratio and Absolute positioning
                container.style.aspectRatio = "16/9";
                container.style.height = "auto"; 
                
                player.style.height = "100%";
                player.style.position = ""; // Reset inline style
                player.classList.add('absolute', 'inset-0', 'h-full'); // Add back Tailwind classes
                
                player.src = src;
                player.allow = "autoplay; encrypted-media; picture-in-picture";
            }
        }

        async function loadFromFirestore() {
            if(!userId) return;
            
            // 1. Fetch Sessions for Stats (Full History)
            const sessionsSnap = await getDocs(getSessionsRef());
            let totalMins = 0;
            const sessionData = [];
            const dates = [];
            
            sessionsSnap.forEach(doc => {
                const data = doc.data();
                totalMins += (data.duration || 0);
                sessionData.push(data);
                if(data.date) dates.push(data.date);
            });

            // Calc Total Hours
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            document.getElementById('totalFocus').textContent = `${h}h ${m}m`;

            // Calc Streak
            const uniqueDates = [...new Set(dates)].sort();
            let streak = 0;
            if(uniqueDates.length > 0) {
                // Simple contiguous streak calc
                let currentStreak = 1;
                const todayStr = new Date().toISOString().slice(0, 10);
                
                // If last session was not today or yesterday, streak is broken
                const lastSessionDate = new Date(uniqueDates[uniqueDates.length-1]);
                const diffTime = Math.abs(new Date(todayStr) - lastSessionDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays > 1) {
                    streak = 0;
                } else {
                    // Iterate backwards
                    streak = 1; 
                    for(let i = uniqueDates.length - 1; i > 0; i--) {
                        const d1 = new Date(uniqueDates[i]);
                        const d2 = new Date(uniqueDates[i-1]);
                        const diff = (d1 - d2) / (1000 * 60 * 60 * 24);
                        if(Math.round(diff) === 1) {
                            streak++;
                        } else {
                            break;
                        }
                    }
                }
            }
            document.getElementById('streakCounter').textContent = `${streak} üî•`;

            renderGitHubGraph(sessionData);
            
            // 2. Fetch Tasks
            renderTasks();
        }

        // -------------------- Task Logic --------------------
        
        window.toggleAddTask = () => {
             resetForm();
             document.getElementById('addTaskForm').classList.remove('hidden');
        };
        
        document.getElementById('toggleAddTask').addEventListener('click', window.toggleAddTask);
        
        document.getElementById('cancelAddTask').addEventListener('click', () => {
            document.getElementById('addTaskForm').classList.add('hidden');
            resetForm();
        });

        function resetForm() {
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskEst').value = '1';
            document.getElementById('saveTask').textContent = 'SAVE';
            document.getElementById('formTitle').textContent = 'ADD NEW TASK';
            editingTaskId = null;
        }

        document.getElementById('saveTask').addEventListener('click', async () => {
            const title = document.getElementById('newTaskTitle').value;
            const est = document.getElementById('newTaskEst').value;
            const saveBtn = document.getElementById('saveTask');

            if(!title || !userId) return;

            // Loading State
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<div class="flex items-center justify-center"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i></div>`;
            lucide.createIcons();

            try {
                if (editingTaskId) {
                    await updateDoc(doc(getTasksRef(), editingTaskId), {
                        title: title,
                        est_pomodoros: parseInt(est)
                    });
                    showSnackbar("Task updated!", "success");
                } else {
                    await addDoc(getTasksRef(), {
                        title: title,
                        est_pomodoros: parseInt(est),
                        act_pomodoros: 0,
                        is_completed: 0,
                        is_active: 0,
                        created_at: Date.now()
                    });
                }
                document.getElementById('addTaskForm').classList.add('hidden');
                resetForm();
                renderTasks();
            } catch (error) {
                console.error("Error saving task:", error);
                showSnackbar("Failed to save task", "error");
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        });

        window.editTask = async (id) => {
             if(!userId) return;
             const docSnap = await getDoc(doc(getTasksRef(), id));
             if (docSnap.exists()) {
                 const task = docSnap.data();
                 document.getElementById('newTaskTitle').value = task.title;
                 document.getElementById('newTaskEst').value = task.est_pomodoros;
                 
                 editingTaskId = id;
                 document.getElementById('saveTask').textContent = 'UPDATE';
                 document.getElementById('formTitle').textContent = 'EDIT TASK';
                 document.getElementById('addTaskForm').classList.remove('hidden');
                 document.getElementById('addTaskForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
             }
        };

        function formatMinutes(mins) {
            if (!mins) return '0m';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        async function renderTasks() {
            if (!userId) return;
            
            const tasksSnap = await getDocs(getTasksRef());
            let tasks = [];
            
            tasksSnap.forEach(doc => tasks.push({id: doc.id, ...doc.data()}));
            
            await Promise.all(tasks.map(async (task) => {
                const subSnap = await getDocs(getTaskSubtasksRef(task.id));
                task.subtasks = [];
                subSnap.forEach(subDoc => {
                    task.subtasks.push({id: subDoc.id, ...subDoc.data()});
                });
                task.subtasks.sort((a,b) => a.created_at - b.created_at);
            }));
            
            tasks.sort((a, b) => {
                if (a.is_completed !== b.is_completed) return a.is_completed - b.is_completed;
                return b.created_at - a.created_at;
            });

            const listEl = document.getElementById('taskList');
            listEl.innerHTML = '';
            
            const activeTask = tasks.find(t => t.is_active === 1 && t.is_completed === 0);
            if(activeTask) {
                document.getElementById('currentTaskDisplay').classList.remove('hidden');
                document.getElementById('currentTaskTitle').textContent = activeTask.title;
                localStorage.setItem('activeTaskTitle', activeTask.title);
            } else {
                document.getElementById('currentTaskDisplay').classList.add('hidden');
                localStorage.removeItem('activeTaskTitle');
            }

            if(tasks.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500 py-4 italic text-sm">No tasks yet. Add one to get started!</div>';
                return;
            }

            tasks.forEach(task => {
                const subtasks = task.subtasks || [];
                const completedSubtasks = subtasks.filter(s => s.is_completed).length;
                const progressPct = subtasks.length > 0 ? (completedSubtasks / subtasks.length) * 100 : 0;
                
                const totalMinutes = task.total_minutes || 0;
                const timeDisplay = formatMinutes(totalMinutes);

                const el = document.createElement('div');
                el.className = `rounded-lg border mb-3 overflow-hidden transition-all ${
                    task.is_active ? 'border-green-500 bg-green-50 dark:bg-green-900/10 dark:border-green-900' : 'border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800'
                } ${task.is_completed ? 'opacity-60' : ''}`;

                let subtasksHtml = '';
                subtasks.forEach(sub => {
                    subtasksHtml += `
                        <div class="flex items-center gap-2 py-1 ml-4 subtask-line">
                             <button onclick="toggleSubtaskComplete('${sub.id}', ${sub.is_completed}, '${task.id}')" class="text-gray-400 hover:text-green-500 p-1">
                                <i data-lucide="${sub.is_completed ? 'check-square' : 'square'}" class="w-4 h-4 ${sub.is_completed ? 'text-green-500' : ''}"></i>
                             </button>
                             <span class="text-xs ${sub.is_completed ? 'line-through text-gray-400' : 'text-gray-600 dark:text-gray-300'}">${sub.title}</span>
                             <button onclick="deleteSubtask('${sub.id}', '${task.id}')" class="ml-auto text-gray-400 hover:text-red-400 p-1">
                                <i data-lucide="x" class="w-3 h-3"></i>
                             </button>
                        </div>
                    `;
                });

                el.innerHTML = `
                    <div class="p-3 flex items-start gap-3 group relative">
                        <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="setActiveTask('${task.id}')">
                            <button class="text-gray-400 hover:text-green-500 mt-1 p-1" onclick="event.stopPropagation(); toggleTaskComplete('${task.id}', ${task.is_completed})">
                                <i data-lucide="${task.is_completed ? 'check-circle-2' : 'circle'}" class="w-5 h-5 ${task.is_completed ? 'text-green-500 fill-green-500/20' : ''}"></i>
                            </button>
                            <div class="flex-1 overflow-hidden">
                                <div class="font-medium text-sm truncate ${task.is_completed ? 'line-through text-gray-500' : ''}">${task.title}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] text-gray-400 flex items-center gap-1 bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">
                                        <i data-lucide="clock" class="w-3 h-3"></i> ${timeDisplay}
                                    </span>
                                    ${subtasks.length > 0 ? `
                                        <div class="w-20 h-1 bg-gray-200 dark:bg-gray-700 rounded-full">
                                            <div class="h-full bg-green-500 rounded-full transition-all" style="width: ${progressPct}%"></div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="text-xs font-mono text-gray-500 font-bold whitespace-nowrap">
                                <span class="text-base sm:text-lg">${task.act_pomodoros || 0}</span>/<span class="text-xs sm:text-sm">${task.est_pomodoros}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <button class="text-gray-400 hover:text-blue-500 text-xs flex items-center gap-1 p-1" onclick="event.stopPropagation(); toggleSubtaskInput('${task.id}')" title="Add Subtask">
                                    <i data-lucide="list-plus" class="w-4 h-4"></i>
                                </button>
                                <button class="text-gray-400 hover:text-yellow-500 text-xs flex items-center gap-1 p-1" onclick="event.stopPropagation(); editTask('${task.id}')" title="Edit Task">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button class="text-gray-400 hover:text-red-500 transition-opacity p-1" onclick="event.stopPropagation(); deleteTask('${task.id}', this)" title="Delete Task">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="subtask-container-${task.id}" class="px-3 pb-2 ${subtasks.length > 0 ? 'block' : 'hidden'}">
                        ${subtasksHtml}
                    </div>

                    <div id="add-subtask-form-${task.id}" class="hidden px-3 pb-3 pt-1 border-t border-gray-100 dark:border-gray-700/50">
                        <div class="flex gap-2">
                            <input type="text" id="subtask-input-${task.id}" placeholder="Subtask name..." class="flex-1 px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-700 dark:bg-gray-900 focus:outline-none focus:border-green-500">
                            <button onclick="addSubtask('${task.id}', this)" class="px-2 py-1 bg-green-500 text-white rounded text-xs flex items-center justify-center min-w-[40px]">Add</button>
                        </div>
                    </div>
                `;
                listEl.appendChild(el);
            });
            lucide.createIcons();
        }

        window.toggleSubtaskInput = (taskId) => {
            const form = document.getElementById(`add-subtask-form-${taskId}`);
            form.classList.toggle('hidden');
        };

        window.addSubtask = async (taskId, btn) => {
            const input = document.getElementById(`subtask-input-${taskId}`);
            const title = input.value;
            if(!title) return;
            
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>`;
            lucide.createIcons();

            try {
                await addDoc(getTaskSubtasksRef(taskId), {
                    title: title,
                    is_completed: 0,
                    created_at: Date.now()
                });
                renderTasks();
            } catch (error) {
                console.error("Error adding subtask:", error);
                showSnackbar("Failed to add subtask", "error");
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        };

        window.deleteSubtask = async (subId, taskId) => {
            await deleteDoc(doc(getTaskSubtasksRef(taskId), subId));
            renderTasks();
        };

        window.toggleSubtaskComplete = async (subId, currentStatus, taskId) => {
            const newStatus = currentStatus ? 0 : 1;
            await updateDoc(doc(getTaskSubtasksRef(taskId), subId), { is_completed: newStatus });
            renderTasks();
        };

        window.setActiveTask = async (id) => {
            const snapshot = await getDocs(getTasksRef());
            const batchPromises = [];
            snapshot.forEach(d => {
                if(d.data().is_active === 1) {
                    batchPromises.push(updateDoc(doc(getTasksRef(), d.id), { is_active: 0 }));
                }
            });
            await Promise.all(batchPromises);
            await updateDoc(doc(getTasksRef(), id), { is_active: 1 });
            renderTasks();
        };

        window.toggleTaskComplete = async (id, currentStatus) => {
            const newStatus = currentStatus ? 0 : 1;
            const completedAt = newStatus === 1 ? Date.now() : null;
            await updateDoc(doc(getTasksRef(), id), {
                is_completed: newStatus,
                is_active: 0,
                completed_at: completedAt
            });
            renderTasks();
        };

        window.deleteTask = async (id, btn) => {
            if(confirm("Delete this task and all its subtasks?")) {
                
                const originalContent = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-red-500"></i>`;
                lucide.createIcons();

                try {
                    const subRef = getTaskSubtasksRef(id);
                    const subSnap = await getDocs(subRef);
                    const batchPromises = [];
                    subSnap.forEach(d => {
                        batchPromises.push(deleteDoc(doc(subRef, d.id)));
                    });
                    await Promise.all(batchPromises);

                    await deleteDoc(doc(getTasksRef(), id));
                    
                    renderTasks();
                } catch (error) {
                    console.error("Error deleting task:", error);
                    showSnackbar("Failed to delete task", "error");
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            }
        }

        // -------------------- Sync Logic --------------------
        const toggleSyncBtn = document.getElementById('toggleSync');
        const syncModal = document.getElementById('syncModal');
        const closeSyncBtn = document.getElementById('closeSync');
        const importTasksBtn = document.getElementById('importTasksBtn');
        const copyToRemindersBtn = document.getElementById('copyToReminders');

        toggleSyncBtn.addEventListener('click', () => syncModal.classList.remove('hidden'));
        closeSyncBtn.addEventListener('click', () => syncModal.classList.add('hidden'));

        importTasksBtn.addEventListener('click', async () => {
            const text = document.getElementById('importText').value;
            if(!text) return;
            
            // Loading State
            const originalText = importTasksBtn.innerHTML;
            importTasksBtn.disabled = true;
            importTasksBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Importing...</div>`;
            lucide.createIcons();

            try {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const promises = lines.map(line => addDoc(getTasksRef(), {
                    title: line.trim(),
                    est_pomodoros: 1,
                    act_pomodoros: 0,
                    is_completed: 0,
                    is_active: 0,
                    created_at: Date.now()
                }));
                
                await Promise.all(promises);
                renderTasks();
                document.getElementById('importText').value = '';
                syncModal.classList.add('hidden');
                showSnackbar(`Imported ${lines.length} tasks!`, "success");
            } catch (e) {
                console.error("Import error:", e);
                showSnackbar("Error importing tasks", "error");
            } finally {
                importTasksBtn.disabled = false;
                importTasksBtn.innerHTML = originalText;
            }
        });

        copyToRemindersBtn.addEventListener('click', async () => {
            if(!userId) return;
            const snapshot = await getDocs(getTasksRef());
            const tasks = [];
            snapshot.forEach(d => {
                const data = d.data();
                if(data.is_completed === 0) tasks.push(data.title);
            });
            if(tasks.length === 0) {
                 showSnackbar("No active tasks to copy.", "info");
                 return;
            }
            const clipboardText = tasks.join('\n');
            navigator.clipboard.writeText(clipboardText).then(() => {
                showSnackbar("Copied! Paste into Apple Reminders.", "success");
            });
        });

        // -------------------- Timer State & Persistence --------------------
        
        let timerState = {
            intervalID: null,
            totalSeconds: 0,
            remainingSeconds: 0,
            isPaused: false,
            mode: "focus",
            endTime: null 
        };

        const timerDisplay = document.getElementById('timerDisplay');
        const timerRing = document.getElementById('timerRing');
        const tree = document.getElementById('treeContainer');
        const pauseIcon = document.getElementById('pauseIcon');
        const modeLabel = document.getElementById('modeLabel');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const resetButton = document.getElementById('resetButton');
        const skipBreakButton = document.getElementById('skipBreak');
        const focusSelect = document.getElementById('focusTime');
        const breakSelect = document.getElementById('breakTime');
        const musicPlayerContainer = document.getElementById('musicPlayer');
        const youtubePlayer = document.getElementById('youtubePlayer');
        const closeMusicPlayerBtn = document.getElementById('closeMusicPlayer');
        const endSound = new Audio('https://upload.wikimedia.org/wikipedia/commons/3/34/Sound_Effect_-_Notifications_01.ogg');

        function saveLocalState() {
            localStorage.setItem('pomodoroTimer', JSON.stringify({
                mode: timerState.mode,
                totalSeconds: timerState.totalSeconds,
                remainingSeconds: timerState.remainingSeconds,
                isPaused: timerState.isPaused,
                endTime: timerState.endTime,
                timestamp: Date.now()
            }));
        }

        function restoreLocalState() {
            const saved = JSON.parse(localStorage.getItem('pomodoroTimer'));
            const activeTaskTitle = localStorage.getItem('activeTaskTitle');
            
            if (activeTaskTitle) {
                document.getElementById('currentTaskDisplay').classList.remove('hidden');
                document.getElementById('currentTaskTitle').textContent = activeTaskTitle;
            }

            if (saved) {
                timerState.mode = saved.mode;
                timerState.totalSeconds = saved.totalSeconds;
                timerState.isPaused = saved.isPaused;
                
                // If it was running, calculate drift
                if (!saved.isPaused && saved.endTime) {
                    const now = Date.now();
                    const left = Math.ceil((saved.endTime - now) / 1000);
                    if (left > 0) {
                        timerState.remainingSeconds = left;
                        timerState.endTime = saved.endTime;
                        updateTimerDisplay(left, saved.totalSeconds);
                        startTimerLoop();
                        updateUIForState('running');
                        return;
                    } else {
                        // Timer finished while closed
                        timerState.remainingSeconds = 0;
                        updateTimerDisplay(0, saved.totalSeconds);
                        window.resetTimer();
                        return;
                    }
                } 
                
                // If paused
                if (saved.isPaused) {
                    timerState.remainingSeconds = saved.remainingSeconds;
                    updateTimerDisplay(timerState.remainingSeconds, timerState.totalSeconds);
                    updateUIForState('paused');
                }
            }
        }

        function updateUIForState(state) {
            modeLabel.textContent = timerState.mode === "focus" ? "Focus Session" : "Break Time";
            modeLabel.className = `text-xl md:text-2xl font-bold mb-4 mt-6 text-center ${timerState.mode === 'focus' ? 'text-green-600 dark:text-green-400' : 'text-blue-600 dark:text-blue-400'}`;
            timerRing.classList.remove('stroke-green-500', 'stroke-blue-500');
            timerRing.classList.add(timerState.mode === 'focus' ? 'stroke-green-500' : 'stroke-blue-500');

            if (state === 'running') {
                startButton.classList.add('hidden');
                resetButton.classList.remove('hidden');
                pauseButton.classList.remove('hidden');
                pauseButton.textContent = 'Pause';
                pauseIcon.classList.add('hidden');
                tree.classList.remove('hidden');
                if (timerState.mode === "break") skipBreakButton.classList.remove('hidden');
            } else if (state === 'paused') {
                startButton.classList.add('hidden');
                resetButton.classList.remove('hidden');
                pauseButton.classList.remove('hidden');
                pauseButton.textContent = 'Resume';
                pauseIcon.classList.remove('hidden');
                tree.classList.add('hidden');
            }
        }

        function updateTimerDisplay(seconds, totalSeconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            timerDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            const circumference = 283;
            const offset = circumference - (circumference * (seconds / totalSeconds));
            timerRing.style.strokeDashoffset = offset;
            document.title = `(${mins}:${secs.toString().padStart(2, '0')}) ${timerState.mode === 'focus' ? 'Focus' : 'Break'} - Pomodoro`;
        }

        function animateTree(total, current) {
            if (!tree) return;
            const progress = 1 - (current / total);
            
            // Growth Stages Logic
            let stage = 'üå±';
            if (progress >= 0.25 && progress < 0.5) stage = 'üåø';
            else if (progress >= 0.5 && progress < 0.75) stage = 'üå≤';
            else if (progress >= 0.75) stage = 'üå≥';
            
            if (tree.textContent !== stage) {
                tree.textContent = stage;
            }

            const scale = 1 + (progress * 0.5);
            tree.style.setProperty('--scale', scale);
            tree.style.transform = `scale(${scale})`;
            
            if (progress > 0.9 && !tree.classList.contains('tree-bounce')) {
                tree.classList.add('tree-bounce');
            } else if (progress <= 0.9) {
                tree.classList.remove('tree-bounce');
            }
        }

        function startTimerLoop() {
             clearInterval(timerState.intervalID);
             timerState.intervalID = setInterval(() => {
                const now = Date.now();
                const secondsLeft = Math.ceil((timerState.endTime - now) / 1000);
                timerState.remainingSeconds = secondsLeft;
                saveLocalState(); 

                if (timerState.remainingSeconds <= 0) {
                    timerState.remainingSeconds = 0;
                    updateTimerDisplay(0, timerState.totalSeconds); 
                    handleSessionEnd();
                    return;
                }
                
                updateTimerDisplay(timerState.remainingSeconds, timerState.totalSeconds);
                animateTree(timerState.totalSeconds, timerState.remainingSeconds);
            }, 1000);
        }

        window.startTimer = (durationMinutes, mode) => {
            clearInterval(timerState.intervalID);
            timerState.mode = mode;
            timerState.totalSeconds = durationMinutes * 60;
            timerState.remainingSeconds = timerState.totalSeconds;
            timerState.isPaused = false;
            timerState.endTime = Date.now() + (timerState.totalSeconds * 1000);
            
            updateUIForState('running');
            if (mode === "break") playBreakMusic();
            else stopBreakMusic();

            updateTimerDisplay(timerState.remainingSeconds, timerState.totalSeconds);
            startTimerLoop();
            saveLocalState();
        };

        window.pauseTimer = () => {
            timerState.isPaused = true;
            clearInterval(timerState.intervalID);
            updateUIForState('paused');
            saveLocalState();
        };

        window.resumeTimer = () => {
            timerState.isPaused = false;
            updateUIForState('running');
            timerState.endTime = Date.now() + (timerState.remainingSeconds * 1000);
            startTimerLoop();
            saveLocalState();
        };

        window.resetTimer = () => {
            clearInterval(timerState.intervalID);
            timerState.isPaused = false;
            timerState.intervalID = null; 
            timerState.mode = "focus";
            const defaultTime = parseInt(focusSelect.value);
            
            updateTimerDisplay(defaultTime * 60, defaultTime * 60);
            timerRing.style.strokeDashoffset = 283;
            
            // Reset Tree
            tree.textContent = 'üå±';
            tree.style.setProperty('--scale', 1);
            tree.style.transform = 'scale(1)';
            tree.classList.remove('tree-bounce', 'hidden');
            pauseIcon.classList.add('hidden');
            
            startButton.classList.remove('hidden');
            pauseButton.classList.add('hidden');
            resetButton.classList.add('hidden');
            skipBreakButton.classList.add('hidden');
            
            modeLabel.textContent = "Focus Session";
            modeLabel.className = "text-xl md:text-2xl font-bold mb-4 mt-6 text-center text-green-600 dark:text-green-400";
            timerRing.classList.remove('stroke-blue-500');
            timerRing.classList.add('stroke-green-500');
            stopBreakMusic();
            document.title = "Pomodoro Focus App";
            
            localStorage.removeItem('pomodoroTimer');
        };

        async function handleSessionEnd() {
            clearInterval(timerState.intervalID);
            localStorage.removeItem('pomodoroTimer');
            endSound.play().catch(e => console.log("Audio needed user interaction:", e));
            
            if (timerState.mode === "focus") {
                const completedTime = parseInt(focusSelect.value);
                
                if(userId) {
                    const snapshot = await getDocs(getTasksRef());
                    let activeTaskId = null;
                    let currentAct = 0;
                    let currentTotalMinutes = 0;
                    
                    snapshot.forEach(d => {
                        const t = d.data();
                        if(t.is_active === 1) {
                            activeTaskId = d.id;
                            currentAct = t.act_pomodoros || 0;
                            currentTotalMinutes = t.total_minutes || 0;
                        }
                    });

                    // 1. Log Session to cloud
                    await addDoc(getSessionsRef(), {
                        date: new Date().toISOString().slice(0, 10),
                        duration: completedTime,
                        timestamp: Date.now(),
                        task_id: activeTaskId
                    });

                    // 2. Update Task stats in cloud
                    if(activeTaskId) {
                        await updateDoc(doc(getTasksRef(), activeTaskId), { 
                            act_pomodoros: currentAct + 1,
                            total_minutes: currentTotalMinutes + completedTime 
                        });
                    }
                    loadFromFirestore();
                }

                showSnackbar("Focus session saved to cloud!", "success");
                window.startTimer(parseInt(breakSelect.value), "break");
            } else {
                showSnackbar("Break over! Ready to focus?", "info");
                window.resetTimer();
            }
        }

        // Attach listeners
        startButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                const proceed = confirm("Sign in with Google to save your stats permanently? Cancel to continue locally (data won't be saved).");
                if (proceed) {
                    try {
                        await window.loginWithGoogle();
                        return;
                    } catch(e) {
                        console.log("Login canceled or failed");
                    }
                }
            }
            window.startTimer(parseInt(focusSelect.value), "focus");
        });

        pauseButton.addEventListener('click', () => { if(timerState.isPaused) window.resumeTimer(); else window.pauseTimer(); });
        resetButton.addEventListener('click', window.resetTimer);
        skipBreakButton.addEventListener('click', () => { stopBreakMusic(); window.resetTimer(); });
        focusSelect.addEventListener('change', () => { if(!timerState.intervalID) updateTimerDisplay(focusSelect.value * 60, focusSelect.value * 60); });

        function renderGitHubGraph(sessionData) {
            const graphEl = document.getElementById('githubGraph');
            graphEl.innerHTML = '';

            const dataMap = {};
            sessionData.forEach(s => {
                dataMap[s.date] = (dataMap[s.date] || 0) + (s.duration || 0);
            });

            const today = new Date();
            const totalDays = 365;
            const startDate = new Date();
            startDate.setDate(today.getDate() - totalDays);
            const startDay = startDate.getDay(); 
            const daysToSubtract = startDay === 0 ? 6 : startDay - 1; 
            startDate.setDate(startDate.getDate() - daysToSubtract);
            
            let currentDate = new Date(startDate);
            while (currentDate <= today) {
                const dateStr = currentDate.toISOString().slice(0, 10);
                const mins = dataMap[dateStr] || 0;
                let colorClass = 'bg-gray-200 dark:bg-gray-700'; // Fixed for Dark Mode visibility
                if (mins > 0) colorClass = 'bg-green-200 dark:bg-green-900';
                if (mins > 30) colorClass = 'bg-green-300 dark:bg-green-800';
                if (mins > 60) colorClass = 'bg-green-400 dark:bg-green-700';
                if (mins > 120) colorClass = 'bg-green-500 dark:bg-green-600';
                if (mins > 240) colorClass = 'bg-green-900 dark:bg-green-500';

                const cell = document.createElement('div');
                cell.className = `contrib-cell ${colorClass} relative group`;
                
                const tooltip = document.createElement('div');
                tooltip.className = 'absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none hidden sm:block';
                tooltip.innerHTML = `<strong>${mins}m</strong> on ${new Date(dateStr).toLocaleDateString(undefined, {month:'short', day:'numeric'})}`;
                
                cell.appendChild(tooltip);
                graphEl.appendChild(cell);
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        // --- Music Utils ---
        function getEmbedUrl(url) {
            if (!url) return null;
            const origin = window.location.origin;
            const videoRegex = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const listRegex = /[?&]list=([^#\&\?]+)/;
            const videoMatch = url.match(videoRegex);
            const listMatch = url.match(listRegex);
            const videoId = (videoMatch && videoMatch[2].length === 11) ? videoMatch[2] : null;
            const listId = listMatch ? listMatch[1] : null;

            if (videoId && listId) return `https://www.youtube.com/embed/${videoId}?list=${listId}&autoplay=1&enablejsapi=1&origin=${origin}`;
            else if (videoId) return `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1&origin=${origin}`;
            else if (listId) return `https://www.youtube.com/embed?listType=playlist&list=${listId}&autoplay=1&enablejsapi=1&origin=${origin}`;
            return null;
        }

        function playBreakMusic() {
            if (document.getElementById('musicToggle').checked === false || !youtubePlayer) return;
            musicPlayerContainer.classList.remove('translate-y-[150%]');
            const storedUrl = cachedSettings.custom_music_url;
            const origin = window.location.origin;
            let embedUrl = `https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&enablejsapi=1&origin=${origin}`;
            if (storedUrl) {
                const calculatedUrl = getEmbedUrl(storedUrl);
                if (calculatedUrl) embedUrl = calculatedUrl;
            }
            youtubePlayer.src = embedUrl;
        }

        function stopBreakMusic() {
            if (!youtubePlayer) return;
            musicPlayerContainer.classList.add('translate-y-[150%]');
            youtubePlayer.src = "";
        }

        // Break Music Settings Modal Logic
        const musicSettingsModal = document.getElementById('musicSettingsModal');
        const openMusicSettingsBtn = document.getElementById('openMusicSettings');
        const closeMusicSettingsBtn = document.getElementById('closeMusicSettings');

        openMusicSettingsBtn.addEventListener('click', () => {
            musicSettingsModal.classList.remove('hidden');
        });

        closeMusicSettingsBtn.addEventListener('click', () => {
            musicSettingsModal.classList.add('hidden');
        });

        document.getElementById('urlForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const url = document.getElementById('videoUrl').value;
            const embedUrl = getEmbedUrl(url);
            if (embedUrl) {
                saveSetting('custom_music_url', url);
                showSnackbar("Break music URL saved!", "success");
                document.getElementById('videoUrl').value = "";
                musicSettingsModal.classList.add('hidden'); // Close modal on save
            } else showSnackbar("Invalid YouTube URL", "error");
        });

        document.getElementById('musicToggle').addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            saveSetting('music_enabled', isEnabled.toString());
            // Show modal if enabling and no URL set (optional, or just always show settings icon)
            if (isEnabled) {
               if(!cachedSettings.custom_music_url) {
                   musicSettingsModal.classList.remove('hidden');
               }
            }
        });

        // Focus Music Settings Logic
        const focusSettingsModal = document.getElementById('focusSettingsModal');
        const openFocusSettingsBtn = document.getElementById('openFocusSettings');
        const closeFocusSettingsBtn = document.getElementById('closeFocusSettings');
        const focusMusicForm = document.getElementById('focusMusicForm');
        const focusSourceRadios = document.querySelectorAll('input[name="focusSource"]');
        const focusUrlHelp = document.getElementById('focusUrlHelp');

        openFocusSettingsBtn.addEventListener('click', () => {
            focusSettingsModal.classList.remove('hidden');
        });

        closeFocusSettingsBtn.addEventListener('click', () => {
            focusSettingsModal.classList.add('hidden');
        });

        focusSourceRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if(e.target.value === 'spotify') {
                    focusUrlHelp.textContent = 'Spotify: Song, Album, or Playlist link.';
                    document.getElementById('focusVideoUrl').placeholder = "https://open.spotify.com/playlist/..."
                } else {
                    focusUrlHelp.textContent = 'YouTube: Video or Playlist link.';
                    document.getElementById('focusVideoUrl').placeholder = "https://youtube.com/watch?v=..."
                }
            });
        });

        focusMusicForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.querySelector('input[name="focusSource"]:checked').value;
            const url = document.getElementById('focusVideoUrl').value;
            const saveBtn = document.getElementById('saveFocusMusicBtn');
            
            // Loading State
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<div class="flex items-center justify-center gap-2"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...</div>`;
            lucide.createIcons();

            try {
                // Save to Firestore
                if(userId) {
                    // Update cache first so UI feels responsive
                    cachedSettings['focus_music_type'] = type;
                    cachedSettings['focus_music_url'] = url;
                    
                    // Write to DB
                    await setDoc(doc(getSettingsRef(), 'config'), cachedSettings, { merge: true });
                    showSnackbar("Focus ambience saved to cloud!", "success");
                } else {
                    showSnackbar("Saved locally (Sign in to sync)", "info");
                }
                
                // Update UI
                updateFocusMusicPlayer(type, url);
                focusSettingsModal.classList.add('hidden');
            } catch(err) {
                console.error("Failed to save focus settings", err);
                showSnackbar("Failed to save settings: " + err.message, "error");
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        });

        // Calendar Modal Logic
        const calendarModal = document.getElementById('calendarModal');
        const openCalendarBtn = document.getElementById('openCalendar');
        const closeCalendarBtn = document.getElementById('closeCalendar');

        openCalendarBtn.addEventListener('click', () => {
            calendarModal.classList.remove('hidden');
        });

        closeCalendarBtn.addEventListener('click', () => {
            calendarModal.classList.add('hidden');
        });

        if(closeMusicPlayerBtn) closeMusicPlayerBtn.addEventListener('click', stopBreakMusic);

        document.getElementById('themeSelect').addEventListener('change', () => {
            const theme = document.getElementById('themeSelect').value;
            saveSetting('theme', theme);
            applyTheme(theme);
        });

        function applyTheme(theme) {
             document.documentElement.className = theme === 'system' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : '') : theme;
        }

        function showSnackbar(message, type = "info") {
            const snackbar = document.getElementById('snackbar');
            if (!snackbar) return;
            snackbar.textContent = message;
            snackbar.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg z-[80] transition-opacity duration-300 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800'} text-white opacity-100 text-sm w-max max-w-[90vw] text-center`;
            setTimeout(() => {
                snackbar.classList.remove('opacity-100');
                snackbar.classList.add('opacity-0');
            }, 3000);
        }
        
        updateTimerDisplay(focusSelect.value * 60, focusSelect.value * 60);
    </script>
  </body>
</html>
